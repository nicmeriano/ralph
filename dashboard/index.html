<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ralph Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/basecoatui/dist/basecoat.min.css">
    <style>
        :root { --ralph-primary: #6366f1; --ralph-success: #22c55e; --ralph-failed: #dc2626; }
        body { min-height: 100vh; background: var(--background); font-family: system-ui, sans-serif; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .logo { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--ralph-primary), #a855f7); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .logo-text { font-size: 1.5rem; font-weight: 700; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; }
        .stat-label { font-size: 0.875rem; color: var(--muted-foreground); margin-bottom: 0.5rem; }
        .stat-value { font-size: 2rem; font-weight: 700; }
        .progress-section { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; }
        .progress-bar-container { background: var(--muted); border-radius: 9999px; height: 12px; overflow: hidden; margin-top: 1rem; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--ralph-primary), #a855f7); border-radius: 9999px; transition: width 0.5s; }
        .current-task-banner { background: linear-gradient(135deg, var(--ralph-primary), #a855f7); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; color: white; }
        .current-task-banner.empty { background: var(--card); border: 1px solid var(--border); color: var(--muted-foreground); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .task-list { display: flex; flex-direction: column; gap: 1rem; }
        .task-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; }
        .task-card.in-progress { border-color: var(--ralph-primary); border-width: 2px; }
        .task-card.done { border-color: var(--ralph-success); opacity: 0.8; }
        .task-card.failed { border-color: var(--ralph-failed); background: rgba(220, 38, 38, 0.05); }
        .task-header { display: flex; justify-content: space-between; margin-bottom: 0.75rem; }
        .task-id { font-family: monospace; font-size: 0.75rem; color: var(--muted-foreground); }
        .task-title { font-weight: 600; margin-bottom: 0.5rem; }
        .badge { display: inline-flex; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .badge-pending { background: var(--muted); color: var(--muted-foreground); }
        .badge-in-progress { background: var(--ralph-primary); color: white; }
        .badge-done { background: var(--ralph-success); color: white; }
        .badge-failed { background: var(--ralph-failed); color: white; }
        .no-feature { text-align: center; padding: 4rem 2rem; color: var(--muted-foreground); }
        .refresh-indicator { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: var(--muted-foreground); }
        .refresh-dot { width: 8px; height: 8px; background: var(--ralph-success); border-radius: 50%; animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .failure-box { margin-top: 0.75rem; padding: 0.75rem; background: rgba(220, 38, 38, 0.1); border: 1px solid var(--ralph-failed); border-radius: 8px; font-size: 0.875rem; }
    </style>
</head>
<body>
    <div class="container" id="app">
        <header class="header">
            <div class="logo"><div class="logo-icon">ðŸ¤–</div><span class="logo-text">Ralph Dashboard</span></div>
            <div style="display:flex;align-items:center;gap:1rem;">
                <select id="feature-select" class="input" style="min-width:200px;"><option value="">Select feature...</option></select>
                <div class="refresh-indicator"><div class="refresh-dot"></div><span>Auto-refresh</span></div>
            </div>
        </header>
        <div id="content"><div class="no-feature"><h2>No Feature Selected</h2><p>Add <code>?feature=name</code> to URL</p></div></div>
    </div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const feature = urlParams.get('feature');
        if (feature) { document.getElementById('feature-select').innerHTML = `<option value="${feature}" selected>${feature}</option>`; loadData(); }
        async function loadData() {
            try {
                // Flat file structure: features/<name>.prd.json
                const prd = await (await fetch(`../features/${feature}.prd.json`)).json();
                let progress = 'No activity yet.';
                try { progress = await (await fetch(`../features/progress.txt`)).text(); } catch(e) {}
                render(prd, progress);
            } catch(e) { document.getElementById('content').innerHTML = `<div class="no-feature"><h2>Feature Not Found</h2><p>${e.message}</p></div>`; }
        }
        function render(prd, progress) {
            // Support both tasks and userStories for backwards compatibility
            const tasks = prd.tasks || prd.userStories || [], total = tasks.length;
            const completed = tasks.filter(s=>s.passes).length;
            const failed = tasks.filter(s=>s.status==='failed').length;
            const percent = total > 0 ? Math.round((completed/total)*100) : 0;
            const inProgress = tasks.find(s=>s.status==='in_progress');
            document.getElementById('content').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">Completed</div><div class="stat-value" style="color:var(--ralph-success)">${completed}/${total}</div></div>
                    <div class="stat-card"><div class="stat-label">Failed</div><div class="stat-value" style="color:${failed > 0 ? 'var(--ralph-failed)' : 'var(--muted-foreground)'}">${failed}</div></div>
                    <div class="stat-card"><div class="stat-label">Iteration</div><div class="stat-value">${prd.metadata?.currentIteration||0}/${prd.metadata?.maxIterations||'-'}</div></div>
                    <div class="stat-card"><div class="stat-label">Progress</div><div class="stat-value">${percent}%</div></div>
                </div>
                <div class="progress-section"><div style="display:flex;justify-content:space-between"><span>Progress</span><span>${percent}%</span></div><div class="progress-bar-container"><div class="progress-bar-fill" style="width:${percent}%"></div></div></div>
                ${inProgress ? `<div class="current-task-banner pulse"><div style="font-size:0.75rem;opacity:0.8">Currently Working On</div><div style="font-size:1.25rem;font-weight:600">${inProgress.id}: ${inProgress.title}</div></div>` : '<div class="current-task-banner empty">No task in progress</div>'}
                <div class="task-list">${tasks.map(s=>`<div class="task-card ${s.status}"><div class="task-header"><div><span class="task-id">${s.id}</span><div class="task-title">${s.title}</div></div><span class="badge badge-${s.status}">${formatStatus(s.status)}</span></div>${s.status === 'failed' && s.lastFailureReason ? `<div class="failure-box"><strong style="color:var(--ralph-failed)">Last Failure (attempt ${s.failureCount || 1}):</strong> ${s.lastFailureReason}</div>` : ''}</div>`).join('')}</div>`;
        }
        function formatStatus(s) { return {pending:'Pending',in_progress:'In Progress',done:'Done',failed:'Failed'}[s]||s; }
        document.getElementById('feature-select').onchange = e => { if(e.target.value) window.location.search = `?feature=${e.target.value}`; };
        setInterval(() => { if(feature) loadData(); }, 2000);
    </script>
</body>
</html>
